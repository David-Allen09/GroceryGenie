<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrocerGenie — Scan · Track · Cook</title>
  <meta name="description" content="Scan barcodes or snap photos to track pantry stock and expirations; get meal suggestions from what's on hand." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%231e40af' d='M50 6a44 44 0 1 0 0 88 44 44 0 0 0 0-88Zm18 30H32a6 6 0 0 0-6 6v20a6 6 0 0 0 6 6h36a6 6 0 0 0 6-6V42a6 6 0 0 0-6-6Z'/%3E%3Cpath fill='%23fff' d='M35 44h30v14a10 10 0 0 1-10 10H45a10 10 0 0 1-10-10V44z'/%3E%3C/svg%3E" />
  <!-- Tailwind CSS (play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM via Babel (MVP, no build step) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    html, body { height: 100%; }
    body { background: linear-gradient(to bottom, #f8fafc, #fff); }
  </style>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#1e40af" />
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Utilities ----------
    const STORAGE_KEY_ITEMS = "grocergenie_items_v2";
    const STORAGE_KEY_DEVICES = "grocergenie_devices_v1";
    const STORAGE_KEY_SETTINGS = "grocergenie_settings_v1";

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function parseDate(d){ if(!d) return null; const dt=new Date(d); return isNaN(+dt)?null:dt; }
    function daysUntil(dateStr){ const d=parseDate(dateStr); if(!d) return null; const t=new Date(); const ms=d.setHours(0,0,0,0)-t.setHours(0,0,0,0); return Math.round(ms/86400000); }
    function cls(...arr){ return arr.filter(Boolean).join(" "); }

    // ---------- Device taxonomy ----------
    const DEVICE_TYPES = [
      { id: "stovetop", label: "Stovetop" },
      { id: "oven", label: "Oven" },
      { id: "air_fryer", label: "Air Fryer" },
      { id: "slow_cooker", label: "Slow Cooker" },
      { id: "grill", label: "Grill" },
      { id: "microwave", label: "Microwave" },
      { id: "toaster_oven", label: "Toaster Oven" },
      { id: "pressure_cooker", label: "Pressure Cooker / Instant Pot" },
      { id: "rice_cooker", label: "Rice Cooker" },
    ];

    // ---------- Recipes ----------
    const RECIPES = [
      { id: 'r1', name: 'Chicken Fried Rice', ingredients: ['chicken','rice','egg','soy sauce','green onion','garlic'], devices: ['stovetop'], steps: ['Cook rice (preferably day-old).','Sauté diced chicken, add garlic.','Push aside, scramble eggs, mix.','Add rice + soy sauce, toss.','Finish with sliced green onion.'] },
      { id: 'r2', name: 'Beef Tacos', ingredients: ['ground beef','tortillas','onion','cheddar','lettuce','salsa'], devices: ['stovetop'], steps: ['Brown beef with diced onion and seasonings.','Warm tortillas.','Assemble with cheese, lettuce, salsa.'] },
      { id: 'r3', name: 'Bacon & Eggs Skillet', ingredients: ['bacon','egg','potato','onion'], devices: ['stovetop'], steps: ['Crisp bacon, set aside.','Cook diced potato and onion in bacon fat.','Add eggs and scramble; crumble bacon over top.'] },
      { id: 'r4', name: 'Spaghetti Aglio e Olio', ingredients: ['spaghetti','garlic','olive oil','chili flakes','parsley'], devices: ['stovetop'], steps: ['Boil spaghetti until al dente.','Gently sizzle sliced garlic in oil; add chili flakes.','Toss pasta with oil, finish with parsley.'] },
      { id: 'r5', name: 'Grilled Steak & Green Beans', ingredients: ['steak','green beans','garlic','butter'], devices: ['grill','stovetop'], steps: ['Salt steak; grill/sear to temp.','Sauté green beans with garlic and butter.','Rest steak; slice and serve with beans.'] },
      { id: 'r6', name: 'Orange Chicken (shortcut)', ingredients: ['chicken','orange marmalade','soy sauce','rice'], devices: ['stovetop'], steps: ['Pan-fry bite-size chicken until browned.','Stir marmalade + soy for glaze; simmer.','Serve over rice.'] },
      { id: 'r7', name: 'Loaded Nachos', ingredients: ['tortilla chips','ground beef','cheddar','salsa','jalapeño','sour cream'], devices: ['oven','microwave','air_fryer','toaster_oven'], steps: ['Cook beef with seasoning.','Layer chips, beef, cheese; melt.','Top with salsa, jalapeño, sour cream.'] },
      { id: 'r8', name: 'Ramen Upgrade', ingredients: ['ramen','egg','green onion','soy sauce'], devices: ['stovetop'], steps: ['Boil ramen; add seasoning.','Crack in egg to poach or soft-boil separately.','Top with soy and green onion.'] },
      { id: 'r9', name: 'BBQ Chicken Wraps', ingredients: ['chicken','tortillas','bbq sauce','lettuce','cheddar'], devices: [], steps: ['Shred cooked chicken; toss in BBQ sauce.','Wrap with lettuce and cheddar.'] },
      { id: 'r10', name: 'Simple Stir-Fry', ingredients: ['chicken','soy sauce','garlic','mixed veggies','rice'], devices: ['stovetop'], steps: ['Sear chicken; add garlic.','Add veggies; stir-fry with soy sauce.','Serve with rice.'] },
    ];

    // ---------- Barcode Scanner ----------
    function BarcodeScanner({ onDetected }){
      const videoRef = useRef(null);
      const [supported, setSupported] = useState(false);
      const [running, setRunning] = useState(false);
      const streamRef = useRef(null);
      const rafRef = useRef(0);
      const detectorRef = useRef(null);

      useEffect(()=>{ setSupported('BarcodeDetector' in window); },[]);

      async function start(){
        try{
          if(!('BarcodeDetector' in window)) return;
          const formats=['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code'];
          detectorRef.current = new window.BarcodeDetector({ formats });
          const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
          streamRef.current = stream;
          if(videoRef.current){
            videoRef.current.srcObject = stream;
            await videoRef.current.play();
            setRunning(true);
            tick();
          }
        }catch(e){ console.error(e); alert('Unable to access camera. Check permissions and try again.'); }
      }
      function stop(){ setRunning(false); cancelAnimationFrame(rafRef.current); if(streamRef.current){ streamRef.current.getTracks().forEach(t=>t.stop()); } }
      async function tick(){
        if(!running || !videoRef.current || !detectorRef.current) return;
        try{
          const detections = await detectorRef.current.detect(videoRef.current);
          if(detections && detections.length){ onDetected(detections[0].rawValue); stop(); return; }
        }catch(e){}
        rafRef.current = requestAnimationFrame(tick);
      }
      useEffect(()=>()=>stop(),[]);

      return (
        <div className="w-full">
          <div className="flex items-center gap-2 mb-3">
            <button onClick={running?stop:start} className={cls('px-4 py-2 rounded-2xl text-sm font-medium shadow', running?'bg-red-600 text-white':'bg-blue-600 text-white')}>
              {running? 'Stop Scanner' : (supported? 'Start Scanner' : 'Scanner Unavailable')}
            </button>
            {!supported && (<span className="text-xs text-amber-700 bg-amber-100 px-2 py-1 rounded">Your browser doesn't support live scanning. Enter codes manually.</span>)}
          </div>
          <video ref={videoRef} className={cls('w-full rounded-2xl shadow', running?'block':'hidden')} muted playsInline />
        </div>
      );
    }

    // ---------- Open Food Facts Lookup ----------
    async function fetchOFF(barcode){
      const endpoints=[
        `https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(barcode)}.json`,
        `https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`,
      ];
      for(const url of endpoints){
        try{
          const resp = await fetch(url, { mode:'cors' });
          if(!resp.ok) continue;
          const data = await resp.json();
          const p = data.product || data?.data?.product || data?.data;
          if(!p) continue;
          const name = p.product_name || p.generic_name || p.brands || '';
          const brand = p.brands || '';
          const cats = (p.categories_tags || p.categories || '').toString();
          const lc = (name + ' ' + cats).toLowerCase();
          let category='';
          if(lc.includes('chicken')) category='meat';
          else if(lc.includes('beef')) category='meat';
          else if(lc.includes('pork')) category='meat';
          else if(lc.includes('rice')) category='pantry';
          else if(lc.includes('pasta')||lc.includes('spaghetti')) category='pantry';
          else if(lc.includes('cheese')) category='dairy';
          else if(lc.includes('milk')) category='dairy';
          else if(lc.includes('egg')) category='dairy';
          else if(lc.includes('sauce')) category='condiments';
          return { name: name || brand || '', category, brand };
        }catch(e){}
      }
      return null;
    }

    // ---------- Inventory Forms ----------
    function AddItemForm({ onAdd, presetBarcode }){
      const [name,setName]=useState('');
      const [barcode,setBarcode]=useState(presetBarcode||'');
      const [category,setCategory]=useState('');
      const [qty,setQty]=useState(1);
      const [expiry,setExpiry]=useState('');
      const [photo,setPhoto]=useState(null);
      const [loadingLookup,setLoadingLookup]=useState(false);
      const [suggestion,setSuggestion]=useState(null);
      const [lookupErr,setLookupErr]=useState('');
      useEffect(()=>{ setBarcode(presetBarcode||''); },[presetBarcode]);
      function onFile(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>setPhoto(r.result); r.readAsDataURL(f); }
      function reset(){ setName(''); setBarcode(''); setCategory(''); setQty(1); setExpiry(''); setPhoto(null); setSuggestion(null); setLookupErr(''); }
      async function doLookup(){ const code=(barcode||'').trim(); if(!code) return; setLoadingLookup(true); setLookupErr(''); setSuggestion(null); try{ const res=await fetchOFF(code); if(!res){ setLookupErr('No product found. You can still enter details manually.'); } else { setSuggestion(res); if(!name && res.name) setName(res.name); if(!category && res.category) setCategory(res.category); } } catch(e){ setLookupErr('Lookup failed. Try again or fill manually.'); } finally { setLoadingLookup(false); } }
      function applySuggestion(){ if(suggestion?.name) setName(suggestion.name); if(suggestion?.category) setCategory(suggestion.category); }
      function submit(e){ e.preventDefault(); if(!name) return alert('Item name is required.'); onAdd({ id:uid(), name:name.trim(), barcode:barcode.trim(), category:category.trim(), quantity: Math.max(0,Number(qty)||0), expiry: expiry||null, photo: photo||null, addedAt: new Date().toISOString() }); reset(); }
      return (
        <form onSubmit={submit} className="grid gap-3">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium">Item name</label>
              <input value={name} onChange={e=>setName(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" placeholder="e.g., chicken breasts" />
            </div>
            <div>
              <label className="block text-sm font-medium">Barcode</label>
              <div className="flex gap-2 mt-1">
                <input value={barcode} onChange={e=>setBarcode(e.target.value)} className="w-full px-3 py-2 rounded-2xl border" placeholder="scan or type" />
                <button type="button" onClick={doLookup} disabled={!barcode || loadingLookup} className="px-3 py-2 rounded-2xl bg-gray-100 disabled:opacity-50">{loadingLookup? '…' : 'Lookup'}</button>
              </div>
              {suggestion && (
                <div className="text-xs mt-1">
                  <span className="bg-blue-50 text-blue-700 px-2 py-1 rounded">{suggestion.name || 'Unnamed'}{suggestion.brand ? ` • ${suggestion.brand}` : ''}</span>
                  {suggestion.category && <span className="ml-2 text-slate-600">Category: {suggestion.category}</span>}
                  <button type="button" onClick={applySuggestion} className="ml-2 text-blue-700 underline">Use</button>
                </div>
              )}
              {lookupErr && <div className="text-xs text-amber-700 mt-1">{lookupErr}</div>}
            </div>
            <div>
              <label className="block text-sm font-medium">Category</label>
              <input value={category} onChange={e=>setCategory(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" placeholder="meat, pantry, dairy…" />
            </div>
            <div>
              <label className="block text-sm font-medium">Quantity</label>
              <input type="number" min="0" value={qty} onChange={e=>setQty(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" />
            </div>
            <div>
              <label className="block text-sm font-medium">Expiration date</label>
              <input type="date" value={expiry||''} onChange={e=>setExpiry(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" />
            </div>
            <div>
              <label className="block text-sm font-medium">Photo (optional)</label>
              <input type="file" accept="image/*" capture="environment" onChange={onFile} className="w-full mt-1" />
            </div>
          </div>
          {photo && (<div className="mt-1"><img src={photo} alt="preview" className="max-h-48 rounded-2xl border" /></div>)}
          <div className="flex gap-2">
            <button className="px-4 py-2 rounded-2xl bg-blue-600 text-white shadow">Add to inventory</button>
            <button type="button" onClick={reset} className="px-4 py-2 rounded-2xl bg-gray-100">Reset</button>
          </div>
        </form>
      );
    }

    function EditItemRow({ item, onSave, onCancel }){
      const [form,setForm]=useState({ ...item });
      function change(k,v){ setForm(p=>({ ...p, [k]: v })); }
      function onFile(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>change('photo', r.result); r.readAsDataURL(f); }
      return (
        <tr className="bg-yellow-50">
          <td className="p-2"><input className="border rounded px-2 py-1" value={form.name} onChange={e=>change('name', e.target.value)} /></td>
          <td className="p-2"><input className="border rounded px-2 py-1" value={form.barcode||''} onChange={e=>change('barcode', e.target.value)} /></td>
          <td className="p-2"><input className="border rounded px-2 py-1" value={form.category||''} onChange={e=>change('category', e.target.value)} /></td>
          <td className="p-2"><input type="number" className="border rounded px-2 py-1 w-20" value={form.quantity} onChange={e=>change('quantity', Number(e.target.value)||0)} /></td>
          <td className="p-2"><input type="date" className="border rounded px-2 py-1" value={form.expiry||''} onChange={e=>change('expiry', e.target.value)} /></td>
          <td className="p-2">
            <div className="flex items-center gap-2">
              {form.photo && <img src={form.photo} className="h-10 w-10 rounded object-cover border" />}
              <input type="file" accept="image/*" onChange={onFile} />
            </div>
          </td>
          <td className="p-2">
            <div className="flex gap-2">
              <button onClick={()=>onSave(form)} className="px-3 py-1 rounded bg-green-600 text-white">Save</button>
              <button onClick={onCancel} className="px-3 py-1 rounded bg-gray-200">Cancel</button>
            </div>
          </td>
        </tr>
      );
    }

    // ---------- Devices ----------
    function AddDeviceForm({ onAdd, presetBarcode }){
      const [name,setName]=useState('');
      const [type,setType]=useState(DEVICE_TYPES[0].id);
      const [barcode,setBarcode]=useState(presetBarcode||'');
      const [notes,setNotes]=useState('');
      useEffect(()=>{ setBarcode(presetBarcode||''); },[presetBarcode]);
      function submit(e){ e.preventDefault(); if(!name) return alert('Device name is required.'); onAdd({ id:uid(), name:name.trim(), type, barcode:barcode.trim(), notes:notes.trim(), addedAt:new Date().toISOString() }); setName(''); setType(DEVICE_TYPES[0].id); setBarcode(''); setNotes(''); }
      return (
        <form onSubmit={submit} className="grid gap-3">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label className="block text-sm font-medium">Device name</label>
              <input value={name} onChange={e=>setName(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" placeholder="e.g., Ninja Dual Air Fryer" />
            </div>
            <div>
              <label className="block text-sm font-medium">Type</label>
              <select value={type} onChange={e=>setType(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border">
                {DEVICE_TYPES.map(d=> (<option key={d.id} value={d.id}>{d.label}</option>))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium">Barcode (optional)</label>
              <input value={barcode} onChange={e=>setBarcode(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" placeholder="scan or type" />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium">Notes</label>
            <input value={notes} onChange={e=>setNotes(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-2xl border" placeholder="size, accessories, etc." />
          </div>
          <div>
            <button className="px-4 py-2 rounded-2xl bg-blue-600 text-white">Add device</button>
          </div>
        </form>
      );
    }

    function DevicesTab({ devices, setDevices }){
      const [scanResult,setScanResult]=useState('');
      const [filter,setFilter]=useState('');
      const filtered=useMemo(()=>{ const q=filter.toLowerCase().trim(); if(!q) return devices; return devices.filter(d=>[d.name,d.barcode,d.type,d.notes].filter(Boolean).some(x=>x.toLowerCase().includes(q))); },[devices,filter]);
      function remove(id){ setDevices(prev=>prev.filter(d=>d.id!==id)); }
      function typeLabel(id){ return DEVICE_TYPES.find(x=>x.id===id)?.label || id; }
      return (
        <section className="grid gap-4">
          <div className="bg-white rounded-2xl shadow p-4">
            <h2 className="text-lg font-semibold mb-2">Scan device barcode</h2>
            <BarcodeScanner onDetected={code=>setScanResult(code)} />
            <div className="mt-3 text-sm">Result: <span className="font-mono bg-slate-100 px-2 py-1 rounded">{scanResult || '—'}</span></div>
          </div>
          <div className="bg-white rounded-2xl shadow p-4">
            <h2 className="text-lg font-semibold mb-2">Add device</h2>
            <AddDeviceForm presetBarcode={scanResult} onAdd={(dev)=>setDevices(prev=>[dev,...prev])} />
          </div>
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Your devices</h2>
              <input value={filter} onChange={e=>setFilter(e.target.value)} placeholder="Filter devices…" className="px-3 py-2 rounded-2xl border" />
            </div>
            <div className="overflow-x-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-50"><tr><th className="text-left p-2">Name</th><th className="text-left p-2">Type</th><th className="text-left p-2">Barcode</th><th className="text-left p-2">Notes</th><th className="text-left p-2">Actions</th></tr></thead>
                <tbody>
                  {filtered.map(d=> (
                    <tr key={d.id} className="border-t">
                      <td className="p-2">{d.name}</td>
                      <td className="p-2">{typeLabel(d.type)}</td>
                      <td className="p-2 font-mono">{d.barcode || '—'}</td>
                      <td className="p-2">{d.notes || '—'}</td>
                      <td className="p-2"><button onClick={()=>remove(d.id)} className="px-3 py-1 rounded bg-red-600 text-white">Delete</button></td>
                    </tr>
                  ))}
                  {filtered.length===0 && (<tr><td colSpan={5} className="p-6 text-center text-slate-500">No devices yet.</td></tr>)}
                </tbody>
              </table>
            </div>
          </div>
        </section>
      );
    }

    // ---------- Main App ----------
    function App(){
      const [tab,setTab]=useState('planner'); // planner, add, scan, inventory, devices, settings
      const [items,setItems]=useState([]);
      const [devices,setDevices]=useState([]);
      const [scanResult,setScanResult]=useState('');
      const [filter,setFilter]=useState('');
      const [editingId,setEditingId]=useState(null);
      const [settings,setSettings]=useState({ respectDevices:true });

      useEffect(()=>{ try{ const rawI=localStorage.getItem(STORAGE_KEY_ITEMS); if(rawI) setItems(JSON.parse(rawI)); }catch{} try{ const rawD=localStorage.getItem(STORAGE_KEY_DEVICES); if(rawD) setDevices(JSON.parse(rawD)); }catch{} try{ const rawS=localStorage.getItem(STORAGE_KEY_SETTINGS); if(rawS) setSettings(JSON.parse(rawS)); }catch{} },[]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items)); },[items]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEY_DEVICES, JSON.stringify(devices)); },[devices]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); },[settings]);

      function addItem(it){ setItems(prev=>[it,...prev]); setTab('inventory'); }
      function removeItem(id){ setItems(prev=>prev.filter(x=>x.id!==id)); }
      function updateItem(updated){ setItems(prev=>prev.map(x=>x.id===updated.id? updated : x)); setEditingId(null); }
      function adjustQty(id,delta){ setItems(prev=>prev.map(x=>x.id===id? { ...x, quantity: Math.max(0,(x.quantity||0)+delta)}: x)); }

      const filtered = useMemo(()=>{ const q=filter.trim().toLowerCase(); if(!q) return items; return items.filter(x=>[x.name,x.category,x.barcode].filter(Boolean).some(s=>s.toLowerCase().includes(q))); },[items,filter]);

      const pantry = useMemo(()=>{ const tokens=new Set(); for(const it of items){ if((it.quantity||0)<=0) continue; it.name.split(/[^a-zA-Z]+/).forEach(tok=>{ if(tok) tokens.add(tok.toLowerCase()); }); if(it.category) tokens.add(it.category.toLowerCase()); } return tokens; },[items]);

      const deviceTypes = useMemo(()=> new Set(devices.map(d=>d.type)), [devices]);
      function deviceCompatible(r){ if(!settings.respectDevices) return true; if(!r.devices || r.devices.length===0) return true; for(const t of r.devices) if(deviceTypes.has(t)) return true; return false; }
      function recipeScore(r){ const has = r.ingredients.filter(ing=>pantry.has(ing.toLowerCase())).length; let score = has / r.ingredients.length; if(!deviceCompatible(r)) score *= 0.1; return score; }
      const recipeSuggestions = useMemo(()=> RECIPES.map(r=>({ r, score: recipeScore(r), compatible: deviceCompatible(r) })).filter(x=>x.score>=0.35).sort((a,b)=>b.score-a.score), [pantry,deviceTypes,settings]);
      function missingFor(r){ return r.ingredients.filter(ing=>!pantry.has(ing.toLowerCase())); }
      function useForRecipe(r){ const need=new Set(r.ingredients.map(s=>s.toLowerCase())); setItems(prev=>prev.map(it=>{ const itTokens=new Set(it.name.toLowerCase().split(/[^a-z]+/).filter(Boolean)); const match=[...need].some(tok=>itTokens.has(tok)); if(match && (it.quantity||0)>0){ return { ...it, quantity: it.quantity - 1 }; } return it; })); setTab('inventory'); }
      function expStatus(i){ const d=daysUntil(i.expiry); if(d===null) return { label:'—', color:'bg-gray-100 text-gray-600' }; if(d<0) return { label:`expired ${-d}d`, color:'bg-red-100 text-red-700' }; if(d===0) return { label:'expires today', color:'bg-amber-100 text-amber-700' }; if(d<=3) return { label:`${d}d left`, color:'bg-amber-100 text-amber-700' }; if(d<=14) return { label:`${d}d left`, color:'bg-green-100 text-green-700' }; return { label:`${d}d left`, color:'bg-green-50 text-green-700' }; }
      function exportJSON(){ const blob=new Blob([JSON.stringify({ items, devices, settings }, null, 2)], { type:'application/json' }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='grocergenie-data.json'; a.click(); URL.revokeObjectURL(url); }
      function importJSON(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(String(r.result||'{}')); if(Array.isArray(data.items)) setItems(data.items); if(Array.isArray(data.devices)) setDevices(data.devices); if(data.settings && typeof data.settings==='object') setSettings(data.settings); }catch{ alert('Failed to parse file.'); } }; r.readAsText(f); }

      return (
        <div className="min-h-screen text-slate-900">
          <div className="max-w-6xl mx-auto p-4 md:p-8">
            <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
              <div>
                <h1 className="text-2xl md:text-3xl font-bold">GrocerGenie</h1>
                <p className="text-sm text-slate-600">Scan or snap. Track stock. Cook smarter.</p>
              </div>
              <nav className="flex flex-wrap gap-2">
                {[ ['planner','Meal planner'], ['add','Add item'], ['scan','Scan barcode'], ['inventory','Inventory'], ['devices','Devices'], ['settings','Settings'], ].map(([k,label]) => (
                  <button key={k} onClick={()=>setTab(k)} className={cls('px-4 py-2 rounded-2xl text-sm font-medium shadow-sm', tab===k?'bg-blue-600 text-white':'bg-white border')}>{label}</button>
                ))}
              </nav>
            </header>

            {tab==='planner' && (
              <section className="grid gap-6">
                <div className="bg-white rounded-2xl shadow p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="text-lg font-semibold">Suggested meals</h2>
                    {settings.respectDevices ? (
                      <span className="text-xs bg-green-50 text-green-700 px-2 py-1 rounded">Filtering by your devices</span>
                    ) : (
                      <span className="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Ignoring devices</span>
                    )}
                  </div>
                  {recipeSuggestions.length===0 && (<p className="text-sm text-slate-600">Add a few items (and devices) to get tailored suggestions.</p>)}
                  <div className="grid md:grid-cols-2 gap-4">
                    {recipeSuggestions.map(({ r, score, compatible }) => (
                      <div key={r.id} className="border rounded-2xl p-4">
                        <div className="flex items-center justify-between mb-2">
                          <h3 className="font-semibold">{r.name}</h3>
                          <div className="flex items-center gap-2">
                            <span className="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700">{Math.round(score*100)}% match</span>
                            {r.devices && r.devices.length>0 && (
                              <span className={cls('text-xs px-2 py-1 rounded-full', compatible?'bg-green-50 text-green-700':'bg-amber-50 text-amber-700')}>{compatible?'Device OK':'Device missing'}</span>
                            )}
                          </div>
                        </div>
                        {r.devices && r.devices.length>0 && (
                          <p className="text-xs text-slate-600 mb-2">Works with: {r.devices.map(id=>DEVICE_TYPES.find(d=>d.id===id)?.label||id).join(', ')}</p>
                        )}
                        <p className="text-sm mb-2"><span className="font-medium">Needs:</span> {r.ingredients.join(', ')}</p>
                        {missingFor(r).length>0 ? (
                          <p className="text-xs text-amber-700 bg-amber-50 inline-block px-2 py-1 rounded">Missing: {missingFor(r).join(', ')}</p>
                        ) : (
                          <p className="text-xs text-green-700 bg-green-50 inline-block px-2 py-1 rounded">You have everything!</p>
                        )}
                        <details className="mt-3">
                          <summary className="cursor-pointer text-sm">Steps</summary>
                          <ol className="list-decimal list-inside text-sm mt-1 space-y-1">
                            {r.steps.map((s,i)=>(<li key={i}>{s}</li>))}
                          </ol>
                        </details>
                        <div className="mt-3 flex gap-2">
                          <button onClick={()=>useForRecipe(r)} className="px-3 py-2 rounded-2xl bg-green-600 text-white text-sm">Cook & use stock</button>
                          <button onClick={()=>setTab('inventory')} className="px-3 py-2 rounded-2xl bg-gray-100 text-sm">View inventory</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white rounded-2xl shadow p-4">
                  <h2 className="text-lg font-semibold mb-2">Quick add</h2>
                  <AddItemForm onAdd={addItem} />
                </div>
              </section>
            )}

            {tab==='add' && (
              <section className="bg-white rounded-2xl shadow p-4">
                <h2 className="text-lg font-semibold mb-2">Add item</h2>
                <AddItemForm onAdd={addItem} />
              </section>
            )}

            {tab==='scan' && (
              <section className="grid gap-4">
                <div className="bg-white rounded-2xl shadow p-4">
                  <h2 className="text-lg font-semibold mb-2">Scan a barcode</h2>
                  <BarcodeScanner onDetected={(code)=>{ setScanResult(code); }} />
                  <div className="mt-3 text-sm">Result: <span className="font-mono bg-slate-100 px-2 py-1 rounded">{scanResult || '—'}</span></div>
                </div>
                <div className="bg-white rounded-2xl shadow p-4">
                  <h2 className="text-lg font-semibold mb-2">Add scanned item</h2>
                  <AddItemForm onAdd={addItem} presetBarcode={scanResult} />
                </div>
              </section>
            )}

            {tab==='inventory' && (
              <section className="bg-white rounded-2xl shadow p-4">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                  <h2 className="text-lg font-semibold">Inventory</h2>
                  <div className="flex items-center gap-2">
                    <input value={filter} onChange={e=>setFilter(e.target.value)} placeholder="Filter by name, category, barcode…" className="px-3 py-2 rounded-2xl border w-64" />
                    <button onClick={()=>setTab('add')} className="px-3 py-2 rounded-2xl bg-blue-600 text-white">Add</button>
                  </div>
                </div>
                <div className="overflow-x-auto rounded-2xl border">
                  <table className="min-w-full text-sm">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="text-left p-2">Item</th>
                        <th className="text-left p-2">Barcode</th>
                        <th className="text-left p-2">Category</th>
                        <th className="text-left p-2">Qty</th>
                        <th className="text-left p-2">Expires</th>
                        <th className="text-left p-2">Photo</th>
                        <th className="text-left p-2">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filtered.map(it => (
                        editingId===it.id ? (
                          <EditItemRow key={it.id} item={it} onSave={updateItem} onCancel={()=>setEditingId(null)} />
                        ) : (
                          <tr key={it.id} className="border-t">
                            <td className="p-2">
                              <div className="font-medium">{it.name}</div>
                              <div className="text-xs text-slate-500">Added {new Date(it.addedAt).toLocaleDateString()}</div>
                            </td>
                            <td className="p-2 font-mono">{it.barcode || '—'}</td>
                            <td className="p-2">{it.category || '—'}</td>
                            <td className="p-2">
                              <div className="flex items-center gap-2">
                                <button onClick={()=>adjustQty(it.id,-1)} className="px-2 py-1 rounded bg-gray-100">-</button>
                                <span>{it.quantity || 0}</span>
                                <button onClick={()=>adjustQty(it.id,+1)} className="px-2 py-1 rounded bg-gray-100">+</button>
                              </div>
                            </td>
                            <td className="p-2"><span className={cls('text-xs px-2 py-1 rounded-full', expStatus(it).color)}>{expStatus(it).label}</span></td>
                            <td className="p-2">{it.photo ? <img src={it.photo} className="h-10 w-10 rounded object-cover border" /> : '—'}</td>
                            <td className="p-2">
                              <div className="flex items-center gap-2">
                                <button onClick={()=>setEditingId(it.id)} className="px-3 py-1 rounded bg-gray-100">Edit</button>
                                <button onClick={()=>removeItem(it.id)} className="px-3 py-1 rounded bg-red-600 text-white">Delete</button>
                              </div>
                            </td>
                          </tr>
                        )
                      ))}
                      {filtered.length===0 && (<tr><td colSpan={7} className="p-6 text-center text-slate-500">No items yet. Add some to get started.</td></tr>)}
                    </tbody>
                  </table>
                </div>
              </section>
            )}

            {tab==='devices' && (<DevicesTab devices={devices} setDevices={setDevices} />)}

            {tab==='settings' && (
              <section className="bg-white rounded-2xl shadow p-4 grid gap-4">
                <h2 className="text-lg font-semibold">Settings & Data</h2>
                <div className="flex items-center gap-2">
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={settings.respectDevices} onChange={e=>setSettings(s=>({ ...s, respectDevices: e.target.checked }))} />
                    Only show/boost recipes I can make with my devices
                  </label>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={exportJSON} className="px-3 py-2 rounded-2xl bg-gray-100">Export data (items + devices + settings)</button>
                  <label className="px-3 py-2 rounded-2xl bg-gray-100 cursor-pointer">Import JSON
                    <input type="file" accept="application/json" className="hidden" onChange={importJSON} />
                  </label>
                  <button onClick={()=>{ if(confirm('Clear all data?')){ localStorage.clear(); location.reload(); } }} className="px-3 py-2 rounded-2xl bg-red-50 text-red-700">Clear all</button>
                </div>
                <div className="text-sm text-slate-600">
                  <p><span className="font-medium">Barcode auto-lookup:</span> Uses Open Food Facts. Some products may be missing or mislabeled; you can always edit before saving.</p>
                  <p><span className="font-medium">Privacy:</span> Data stays in your browser (localStorage) unless you export it.</p>
                </div>
              </section>
            )}

            <footer className="text-center text-xs text-slate-500 mt-8">© {new Date().getFullYear()} GrocerGenie — MVP</footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
